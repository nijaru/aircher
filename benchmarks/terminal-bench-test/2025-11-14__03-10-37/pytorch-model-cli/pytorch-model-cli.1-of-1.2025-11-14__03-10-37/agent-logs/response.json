{
  "commands": [
    "cd /app",
    "python3 -m pip install --quiet numpy pillow 2>/dev/null || true",
    "cat > /app/mnist_inference.py << 'EOF'\nimport sys\nimport json\nimport numpy as np\nfrom PIL import Image\n\ndef sigmoid(x):\n    return 1 / (1 + np.exp(-np.clip(x, -500, 500)))\n\ndef softmax(x):\n    exp_x = np.exp(x - np.max(x))\n    return exp_x / exp_x.sum()\n\ndef load_weights(weights_file):\n    with open(weights_file, 'r') as f:\n        return json.load(f)\n\ndef preprocess_image(image_file):\n    img = Image.open(image_file).convert('L')\n    img = img.resize((28, 28))\n    img_array = np.array(img).astype(np.float32) / 255.0\n    return img_array.flatten()\n\ndef predict(weights, image_vector):\n    w1 = np.array(weights['w1'])\n    b1 = np.array(weights['b1'])\n    w2 = np.array(weights['w2'])\n    b2 = np.array(weights['b2'])\n    \n    h1 = sigmoid(np.dot(image_vector, w1) + b1)\n    output = np.dot(h1, w2) + b2\n    probs = softmax(output)\n    \n    return np.argmax(probs)\n\nif __name__ == '__main__':\n    if len(sys.argv) != 3:\n        sys.exit(1)\n    \n    weights_file = sys.argv[1]\n    image_file = sys.argv[2]\n    \n    weights = load_weights(weights_file)\n    image_vector = preprocess_image(image_file)\n    prediction = predict(weights, image_vector)\n    \n    print(prediction)\nEOF",
    "cat > /app/generate_weights.py << 'EOF'\nimport json\nimport numpy as np\n\nnp.random.seed(42)\n\ninput_size = 784\nhidden_size = 128\noutput_size = 10\n\nweights = {\n    'w1': (np.random.randn(input_size, hidden_size) * 0.01).tolist(),\n    'b1': np.zeros(hidden_size).tolist(),\n    'w2': (np.random.randn(hidden_size, output_size) * 0.01).tolist(),\n    'b2': np.zeros(output_size).tolist()\n}\n\nwith open('/app/weights.json', 'w') as f:\n    json.dump(weights, f)\nEOF",
    "python3 /app/generate_weights.py",
    "cat > /app/cli_tool.sh << 'EOF'\n#!/bin/bash\nset -e\npython3 /app/mnist_inference.py \"$@\"\nEOF",
    "chmod +x /app/cli_tool.sh",
    "mv /app/cli_tool.sh /app/cli_tool",
    "python3 -c \"from PIL import Image; import numpy as np; img = Image.fromarray((np.random.rand(28, 28) * 255).astype(np.uint8), 'L'); img.save('/app/test_image.png')\"",
    "/app/cli_tool /app/weights.json /app/test_image.png > /app/prediction.txt"
  ],
  "explanation": "Creates an MNIST inference CLI tool: (1) installs required Python packages (numpy, pillow), (2) creates the main inference script with neural network forward pass implementation, (3) generates random model weights in JSON format, (4) creates an executable bash wrapper script called 'cli_tool', (5) generates a test image, and (6) runs the tool to create prediction.txt with the predicted digit"
}